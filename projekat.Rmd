---
title: Analiza skupa hapsenja u Njujorku
author: Nikola Vukic
output: html_document
---

# Nikola Vukic E2 68-2023

## Specifikacija

Kompletnu specifikaciju za projekat moguce je pronaci [ovde](/home/nikola/Master/R/RVPII-projekat/specifikacija.pdf). <br>
Skup podataka je javno dostupan za [preuzimanje](https://catalog.data.gov/dataset/iowa-liquor-sales). <br>

## Instalacija potrebnih resursa

```{r instalacija, eval=FALSE, include=TRUE}
library(sparklyr)
library(ggplot2)
library(tidyr)
library(dplyr)
library(magrittr)
library(knitr)
library(ggcorrplot)
library(reshape2)

spark_install(version = "3.5.1")
knitr::opts_knit$set(root.dir = "/home/nikola/Master/R/RVPII-projekat")
```

## Priprema podataka

U ovoj fazi bice izbaceni redovi koji sadrze vrednosti obelezja koja nisu dostupna (*NA*). Pored ovoga bice izbacene i kolone tj. obelezja koja nisu relevantna za formiranje modela. 

```{r preciscivanje-podataka, eval=FALSE, include=TRUE}
conf <- spark_config()
conf$`sparklyr.shell.driver-memory` <- "16G"
conf$spark.memory.fraction <- 0.9

sc <- spark_connect(master = "local", config = conf)

path_to_raw_file <- file.path(getwd(), "Iowa_Liquor_Sales.csv")
output_file <- file.path(getwd(), "Iowa_Liquor_Sales")

df <- spark_read_csv(sc, path_to_raw_file)

columns_to_drop <- c(
  "Date",
  "InvoiceItem_Number",
  "Store_Number",
  "Store_Name",
  "Category_Name",
  "Address",
  "City",
  "Store_Location",
  "County",
  "Vendor_Name",
  "Zip_Code",
  "County_Number",
  "Category",
  "County",
  "Vendor_Number",
  "Item_Number",
  "Item_Description",
  "Category_Group",
  "Volume_Sold_Gallons",
  "State_Bottle_Retail"
)

df <- df %>% 
  select(-one_of(columns_to_drop)) %>%
  filter(Pack >= 0) %>%
  filter(Bottles_Sold < 100) %>%
  filter(Bottle_Volume_ml >= 0) %>%
  filter(State_Bottle_Cost >= 0) %>%
  filter(Bottles_Sold >= 0) %>%
  filter(Sale_Dollars >= 0) %>%
  filter(Volume_Sold_Liters >= 0)

df <- df %>% na.omit()

df_sample <- df %>% sdf_sample(fraction = 0.3, replacement = FALSE)

spark_write_csv(df_sample, path = output_file, mode = "overwrite", delimiter = ",")
```

## Preliminarna analiza podataka

### 1. Deskriptivna statistika 

```{r deskriptivna-statistika, eval=FALSE, include=TRUE}
df <- spark_read_csv(sc, "Iowa_Liquor_Sales")

column_names <- colnames(df)

calculate_summary <- function(col_name) {
  df %>%
    summarize(
      count = n(),
      min = min(!!sym(col_name)),
      max = max(!!sym(col_name)),
      mean = mean(!!sym(col_name)),
      median = percentile_approx(!!sym(col_name), 0.5)
    )
}

summary_stats_list <- lapply(column_names, function(col) {
  calculate_summary(col) %>%
    collect()
})

summary_matrix <- do.call(rbind, summary_stats_list)

summary_matrix_df <- as.data.frame(summary_matrix)

rownames(summary_matrix_df) <- column_names

descriptive_statistics_matrix <- kable(summary_matrix_df, "html") 

writeLines(descriptive_statistics_matrix, "assets/descriptive_statistics_matrix.html") 
```
**Rezultat racunanja deskriptivne stattisike polja:**

<iframe src="assets/descriptive_statistics_matrix.html" style="margin: 0 auto; display: block;" width="465px" height="180px"></iframe>

### 2. Vizualizovanje raspodele po pojedinacnim obelezjima

```{r sampling-utils, eval=FALSE, include=FALSE}
sample_df <- sdf_sample(df, 0.5, TRUE, 123)
```

```{r vr-Bottles_Sold, eval=FALSE, include=FALSE }
grouped_df <- sample_df %>%
  group_by(Bottles_Sold) %>%
  summarise(count = n()) %>%
  collect()

glimpse(grouped_df)

hist <- ggplot(grouped_df, aes(x = Bottles_Sold, y = count)) +
  geom_bar(stat = "identity", fill = "black") +
  labs(
    x = "Broj prodanih flasa",
    y = "Broj kupovina"
  ) +
  scale_x_continuous(limits = c(0, 1000), labels = scales::comma, breaks = seq(0, 1000, by = 200)) +  # Adjust the upper limit to 1000
  scale_y_continuous(labels = scales::comma, breaks = seq(0, 1000, by = 200)) +  # Adjust the upper limit to 1000 for y-axis as well
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Save the modified histogram
png_filename <- "assets/bottles_sold.png"
ggsave(
  filename = png_filename, 
  plot = hist, 
  width = 10, height = 6, dpi = 300
)
```

### 3. Korelaciona matrica obelezja

```{r korelaciona-matrica-obelezja, eval=FALSE, include=TRUE}
sampled_numeric_df <- df %>% 
  sdf_sample(fraction = 0.7, replacement = FALSE) %>%
  collect()

correlation_matrix <- cor(sampled_numeric_df)

p <- ggcorrplot(cor(correlation_matrix), hc.order = TRUE,
           type = "lower",
           lab = TRUE, 
           ggtheme = ggplot2::theme_gray,
           colors = c("#5986f0", "white", "#f05959"))
ggsave("assets/correlation_plot.png", p)
```

**Matrica korelacije:**
![](assets/correlation_plot.png)

## Klasifikacija

```{r kreiranje-validacionog-skupa, eval=FALSE, include=TRUE}
clusterisation_dataset <- sdf_random_split(
  df, 
  seed=123, 
  training=0.7,
  validation=0.3
)

training <- clusterisation_dataset$training 
validation <- clusterisation_dataset$validation 

formula <- Bottles_Sold ~ State_Bottle_Cost + Volume_Sold_Liters

size <- c(1:3)
max_iters <- size * 10
max_depths <- size * 5
```

### 1. Stabla odlucivanja

##### Obucavanje i evaluacija tacnosti 

```{r decision-tree-classifier, eval=FALSE, include=TRUE}
accuracies <- size

for(i in size) {
  model <- training %>%
    ml_decision_tree_classifier(formula, max_depth = max_depths[[i]])

  eval <- ml_evaluate(model, validation)
  
  accuracies[i] <- eval$Accuracy
}

dtc_accuracies <- accuracies
```

```{r dtc-depth-vs-accuracy, eval=FALSE, include=TRUE}
results_df <- data.frame(max_depth = max_depths, accuracy = accuracies)

p <- ggplot(results_df, aes(x = factor(max_depth), y = accuracy)) +
  geom_bar(stat = "identity", fill = "grey", color = "black") +  
  labs(x = "Maksimalna dubina",
       y = "Tacnost modela") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("assets/dtc_max_depth_vs_accuracy.png", plot = p, width = 8, height = 6)
```

**Rezultujuci grafikon: **

![](assets/dtc_max_depth_vs_accuracy.png)

#### Evaluacija preciznosti unakrsnom validacijom


```{r dtc-validation, eval=FALSE, include=TRUE}
pip <- sc %>% 
    ml_pipeline() %>%
    ft_r_formula(formula) %>%
    ml_decision_tree_classifier()

param_grid <- list(
  decision_tree_classifier = list(max_depth = max_depths)
)

evaluator <- ml_multiclass_classification_evaluator(
  x=sc, 
  metric_name="accuracy"
)

validator <- ml_cross_validator(
  x=sc, 
  estimator=pip, 
  evaluator=evaluator, 
  estimator_param_maps=param_grid, 
  num_folds=5
)

fit <- ml_fit(x = validator, dataset = df)
metrics <- ml_validation_metrics(fit)

p <- metrics %>%
  ggplot(aes(x = factor(max_depths), y = accuracy)) + 
  geom_bar(stat = "identity", fill = "grey", color = "black") +
  labs(x = "Maksimalna dubina",
       y = "Tacnost modela")

ggsave("assets/dtc_k_fold_validation.png", p)
```

**Tacnost u zavisnosti od dubine, procena napravljena unakrsenom validacijom:**

![](assets/dtc_k_fold_validation.png)

### 2. Logisticka regresija

##### Obucavanje i ocena performansi

```{r logistic-regression, eval=FALSE, include=TRUE}
lr_precs <- size
lr_recalls <- size
lr_f_measures <- size
lr_accuracies <- size

for(i in size) {
  model <- ml_logistic_regression(training, formula, max_iter = max_iters[[i]])
  eval <- ml_evaluate(model, validation)
  lr_precs[i] <- eval$weighted_precision()
  lr_recalls[i] <- eval$weighted_recall()
  lr_f_measures[i] <- eval$weighted_f_measure()
  lr_accuracies[i] <- eval$accuracy()
}
```

```{r lr-max-iters-vs-accuracy, eval=FALSE, include=TRUE}
results_df <- data.frame(max_depth = max_iters, accuracy = lr_accuracies)

p <- ggplot(results_df, aes(x = factor(max_depth), y = accuracy)) +
  geom_bar(stat = "identity", fill = "grey", color = "black") +  
  labs(x = "Broj iteracija",
       y = "Tacnost modela") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("assets/lr_max_iters_vs_accuracy.png", plot = p, width = 8, height = 6)

results_df <- data.frame(max_depth = max_iters, accuracy = lr_f_measures)

p <- ggplot(results_df, aes(x = factor(max_depth), y = accuracy)) +
  geom_bar(stat = "identity", fill = "grey", color = "black") +  
  labs(x = "Broj iteracija",
       y = "Rezultujuci F1-skor") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("assets/lr_max_iters_vs_lr_f_measures.png", plot = p, width = 8, height = 6)

results_df <- data.frame(max_depth = max_iters, accuracy = lr_recalls)

p <- ggplot(results_df, aes(x = factor(max_depth), y = accuracy)) +
  geom_bar(stat = "identity", fill = "grey", color = "black") +  
  labs(x = "Broj iteracija",
       y = "Osetljivost modela") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("assets/lr_max_iters_vs_lr_recalls.png", plot = p, width = 8, height = 6)

results_df <- data.frame(max_depth = max_iters, accuracy = lr_precs)

p <- ggplot(results_df, aes(x = factor(max_depth), y = accuracy)) +
  geom_bar(stat = "identity", fill = "grey", color = "black") +  
  labs(x = "Broj iteracija",
       y = "Preciznost modela") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("assets/lr_max_iters_vs_lr_precs.png", plot = p, width = 8, height = 6)
```
 
**Rezultujuci grafikoni:**
 
![Tacnost u odnosu na broj iteracija](assets/lr_max_iters_vs_accuracy.png)
![F1-skor u odnosu na broj iteracija](assets/lr_max_iters_vs_lr_f_measures.png)
![Osetljivost u odnosu na broj iteracija](assets/lr_max_iters_vs_lr_recalls.png)
![Preciznost u odnosu na broj iteracija](assets/lr_max_iters_vs_lr_precs.png)

#### Evaluacija preciznosti unakrsnom validacijom

```{r lr-validation, eval=FALSE, include=TRUE}
pip <- sc %>% 
    ml_pipeline() %>%
    ft_r_formula(formula) %>%
    ml_logistic_regression()

param_grid <- list(
  logistic_regression = list(max_iter = max_iters)
)

evaluator <- ml_multiclass_classification_evaluator(
  x = sc, 
  metric_name = "accuracy"
)

validator <- ml_cross_validator(
  x = sc, estimator = pip, 
  evaluator=evaluator, 
  estimator_param_maps=param_grid, 
  num_folds=5
)

fit <- ml_fit(x = validator, dataset = df)
metrics <- ml_validation_metrics(fit)

p <- metrics %>%
  ggplot(aes(x = factor(max_depths), y = accuracy)) + 
  geom_bar(stat = "identity", fill = "grey", color = "black") +
  labs(x = "Maksimalan broj iteracija",
       y = "Preciznost modela")

ggsave("assets/lr_k_fold_validation.png", p)
```

**Tacnost u zavisnosti od maksimalnog broja iteracija, procena napravljena unakrsenom validacijom:**

![](assets/lr_k_fold_validation.png)

### 3. Random Forest

##### Obucavanje i ocena tacnosti

```{r random-forest, eval=FALSE, include=TRUE}
rf_accuracies <- matrix(nrow = 3, ncol = 3)

tree_count <- max_depths

for(i in size) {
  for(j in size) {
    model <- ml_random_forest_classifier(
      training,
      formula, 
      num_trees = tree_count[[i]], 
      max_depth = max_depths[[j]]
    )
    eval <- ml_evaluate(model, validation)
    
    rf_accuracies[i, j] <- eval$Accuracy
  }
}

dimnames(rf_accuracies) <- list(
  paste("Trees", tree_count),
  paste("Depth", max_depths)
)

rf_accuracies
```

```{r rf-tree-count-vs-accuracy, eval=FALSE, include=TRUE}
results_df <- as.data.frame(rf_accuracies)
results_df <- cbind(expand.grid(Trees = c(5, 10, 15), Depth = c(5, 10, 15)), results_df)

trees <- c(5, 10, 15)
depths <- c(5, 10, 15)

results_df <- expand.grid(Trees = trees, Depth = depths)
results_df$Accuracy <- as.vector(rf_accuracies)

p <- ggplot(results_df, aes(x = factor(Depth), y = factor(Trees), fill = Accuracy, label = round(Accuracy, 3))) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#f05959", high = "#5986f0") +
  labs(x = "Maksimalna dubina", y = "Broj stabala", fill = "Tacnost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(size = 3, color = "black")

ggsave("assets/random_forest_accuracies_matrix.png", plot = p, width = 8, height = 6)
```
**Rezultujuci grafikon:**

![](assets/random_forest_accuracies_matrix.png)

#### Evaluacija preciznosti unakrsnom validacijom

```{r rf-validation, eval=FALSE, include=TRUE}
pip <- sc %>% 
    ml_pipeline() %>%
    ft_r_formula(formula) %>%
    ml_random_forest_classifier()

param_grid <- list(
  random_forest_classifier = list(
    max_depth = max_depths, 
    num_trees = tree_count
  )
)

evaluator <- ml_multiclass_classification_evaluator(
  x=sc, 
  metric_name="accuracy"
)

validator <- ml_cross_validator(
  x=sc, 
  estimator=pip, 
  evaluator=evaluator, 
  estimator_param_maps=param_grid, 
  num_folds=5
)

fit <- ml_fit(x = validator, dataset = df)
metrics <- ml_validation_metrics(fit)

p <- ggplot(metrics, aes(x = factor(max_depth_1), y = factor(num_trees_1), fill = accuracy, label = round(accuracy, 3))) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#f05959", high = "#5986f0") +
  labs(x = "Maksimalna dubina", y = "Broj stabala", fill = "Tacnost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(size = 3, color = "black")

ggsave("assets/rf_k_fold_validation.png", p)
```

![](assets/rf_k_fold_validation.png)

#### Poredjene preciznosti za sve scenarije

```{r result-comparison, eval=FALSE, include=TRUE}
rf_df <- as.data.frame(as.table(rf_accuracies))
colnames(rf_df) <- c("num_trees", "max_depth", "accuracy")
rf_df$model <- "Random Forest"

dtc_df <- data.frame(
  num_trees = rep(1, length(max_depths)),
  max_depth = max_depths,
  accuracy = dtc_accuracies,
  model = "Decision Tree"
)

lr_df <- data.frame(
  num_trees = rep(0, length(max_depths)),
  max_depth = max_iters,
  accuracy = lr_accuracies,
  model = "Logistic Regression"
)

rf_df$num_trees <- as.character(rf_df$num_trees)
rf_df$max_depth <- as.character(rf_df$max_depth)
dtc_df$num_trees <- as.character(dtc_df$num_trees)
dtc_df$max_depth <- as.character(dtc_df$max_depth)
lr_df$num_trees <- as.character(lr_df$num_trees)
lr_df$max_depth <- as.character(lr_df$max_depth)

combined_df <- bind_rows(rf_df, dtc_df, lr_df)

p <- ggplot(combined_df, aes(x = max_depth, y = accuracy, fill = model, label = round(accuracy, 3))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "Max Depth", y = "Accuracy", fill = "Model") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(y = accuracy + 0.02), position = position_dodge(width = 0.8), size = 3, color = "black") +
  facet_wrap(~ num_trees, scales = "free_x")

ggsave("assets/combined_model_accuracies.png", plot = p, width = 10, height = 6)
```

![](assets/combined_model_accuracies.png)